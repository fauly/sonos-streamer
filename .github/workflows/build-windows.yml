name: Build Windows Executable

on:
  push:
    branches: [ main ]  # Adjust to your default branch
  workflow_dispatch:    # Allows manual triggering

jobs:
  build:
    runs-on: windows-latest  # Uses GitHub's Windows runner

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # Adjust to your app's Python version

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller  # Install PyInstaller

    - name: Download FFmpeg
      run: |
        # Download FFmpeg Windows build
        $ffmpegUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
        $ffmpegZip = "ffmpeg.zip"
        
        Write-Host "Downloading FFmpeg..."
        Invoke-WebRequest -Uri $ffmpegUrl -OutFile $ffmpegZip
        
        Write-Host "Extracting FFmpeg..."
        Expand-Archive -Path $ffmpegZip -DestinationPath .
        
        # Find the extracted folder and move ffmpeg.exe to a known location
        $ffmpegFolder = Get-ChildItem -Directory -Filter "ffmpeg-*" | Select-Object -First 1
        $ffmpegExe = Join-Path $ffmpegFolder.FullName "bin\ffmpeg.exe"
        
        Write-Host "FFmpeg location: $ffmpegExe"
        
        # Create bin directory and copy ffmpeg.exe
        New-Item -ItemType Directory -Force -Path bin
        Copy-Item $ffmpegExe -Destination "bin\ffmpeg.exe"
        
        Write-Host "FFmpeg copied to bin\ffmpeg.exe"

    - name: Build with PyInstaller
      run: |
        # Bundle FFmpeg with PyInstaller
        pyinstaller --onefile --windowed --add-binary "bin\ffmpeg.exe;." main.py

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-exe  # Name for download
        path: dist/      # PyInstaller outputs to 'dist/' folder
